<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="/src/style.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/src/auth.js" defer></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body class="bg-gray-100">
    <header x-data="navState" x-init="init()" class="flex items-center justify-between md:px-[8vw] px-[3vw] bg-white h-14 text-black shadow-sm fixed top-0 left-0 w-full z-50">
        </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
        </main>

<script type="module">
    import { API_URL } from './src/config.js';

    function getAuthHeader() { return { 'Authorization': `Bearer ${localStorage.getItem('token')}` }; }
    function checkAdmin() { if (localStorage.getItem('userRole') !== 'admin') { alert('Akses ditolak.'); window.location.href = 'login.html'; } }
    checkAdmin();

    function uploadBerita() { 
        return { 
            judul: '', tanggal: '', quill: null, 
            initEditor() { this.quill = new Quill(this.$refs.editor, { theme: 'snow', placeholder: 'Tulis isi berita...' }); }, 
            async submit() { 
                const isiHTML = this.quill.root.innerHTML; 
                const gambarFile = this.$refs.gambarInput.files[0]; 
                if (!this.judul || !this.tanggal || !isiHTML || !gambarFile) { alert("Harap lengkapi semua field."); return; } 
                const formData = new FormData(); 
                formData.append('judul', this.judul); 
                formData.append('tanggal', this.tanggal); 
                formData.append('isi', isiHTML); 
                formData.append('gambar', gambarFile); 
                try { 
                    const response = await fetch(`${API_URL}/api/berita`, { method: 'POST', headers: getAuthHeader(), body: formData }); 
                    if (!response.ok) throw new Error((await response.json()).message || 'Gagal upload berita'); 
                    alert('Berita berhasil diupload!'); 
                    window.location.reload(); 
                } catch (error) { alert(error.message); } 
            } 
        } 
    }

    function profilDesaApp() { 
        return { 
            profil: {}, 
            async loadProfil() { 
                try { 
                    const response = await fetch(`${API_URL}/api/profil`); 
                    if (!response.ok) throw new Error('Gagal memuat profil'); 
                    this.profil = await response.json(); 
                } catch (error) { alert(error.message); } 
            }, 
            async simpanProfil() { 
                try { 
                    const response = await fetch(`${API_URL}/api/profil`, { method: 'PUT', headers: { ...getAuthHeader(), 'Content-Type': 'application/json' }, body: JSON.stringify(this.profil) }); 
                    if (!response.ok) throw new Error((await response.json()).message || 'Gagal menyimpan'); 
                    alert('Profil desa berhasil diperbarui!'); 
                } catch (error) { alert(error.message); } 
            } 
        } 
    }

    function dataManagement() {
        return {
            berita: [],
            peminjaman: [],
            async init() {
                try {
                    const [beritaRes, peminjamanRes] = await Promise.all([
                        fetch(`${API_URL}/api/berita`, { headers: getAuthHeader() }),
                        fetch(`${API_URL}/api/peminjaman`, { headers: getAuthHeader() })
                    ]);
                    if (!beritaRes.ok) throw new Error('Gagal memuat berita');
                    if (!peminjamanRes.ok) throw new Error('Gagal memuat peminjaman');
                    this.berita = await beritaRes.json();
                    this.peminjaman = await peminjamanRes.json();
                } catch (error) { console.error(error); alert(error.message) }
            },
            async deleteBerita(id) {
                if (!confirm('Apakah Anda yakin ingin menghapus berita ini?')) return;
                try {
                    const response = await fetch(`${API_URL}/api/berita/${id}`, { method: 'DELETE', headers: getAuthHeader() });
                    if (!response.ok) throw new Error((await response.json()).message || 'Gagal menghapus berita');
                    alert('Berita berhasil dihapus.');
                    this.init();
                } catch (error) { alert(error.message); }
            },
            async updatePeminjamanStatus(id, newStatus) {
                try {
                    const response = await fetch(`${API_URL}/api/peminjaman/${id}`, { method: 'PUT', headers: { ...getAuthHeader(), 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                    if (!response.ok) throw new Error('Gagal update status');
                    alert('Status peminjaman berhasil diupdate.');
                    this.init();
                } catch (error) { alert(error.message); }
            }
        }
    }

    window.uploadBerita = uploadBerita;
    window.profilDesaApp = profilDesaApp;
    window.dataManagement = dataManagement;
</script>
</body>
</html>