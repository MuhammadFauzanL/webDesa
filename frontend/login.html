<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login & Registrasi - Web Desa</title>
    <!-- Memuat Tailwind CSS & Alpine.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <!-- Memuat Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 h-full" x-data="authApp">

    <!-- PERBAIKAN: Header disamakan dengan index.html -->
   <header x-data="navState" x-init="init()" class="flex items-center justify-between md:px-[8vw] px-[3vw] bg-white h-14 text-black shadow-sm fixed top-0 left-0 w-full z-50">
        <div class="logo"><a class="flex items-center gap-1" href="index.html"><img class="h-7 -mt-1" src="https://img.icons8.com/pastel-glyph/64/40C057/marker--v1.png" alt="marker--v1" /><span class="text-lg font-bold">Desa Cibiru</span></a></div>
        <nav>
            <ul class="flex font-medium items-center gap-4">
                <li><a href="index.html" class="hover:text-emerald-600">Profil</a></li>
                <li><a href="berita.html" class="hover:text-emerald-600">Berita</a></li>
                 
                <li><a href="layanan.html" class="hover:text-emerald-600 font-semibold text-emerald-600">Layanan</a></li>
                <li><a href="/login.html" class="hover:text-emerald-600">Login</a></li>
                <template x-if="isAdmin"><li><a href="admin.html" class="font-semibold text-red-600 hover:text-red-700">Admin Panel</a></li></template>
                <template x-if="isLoggedIn"><li><button @click="logout()" class="bg-gray-200 text-sm font-semibold px-4 py-1.5 rounded-md hover:bg-red-500 hover:text-white transition">Logout</button></li></template>
                <template x-if="!isLoggedIn"><li><a href="login.html" class="bg-emerald-600 text-sm font-semibold text-white px-4 py-1.5 rounded-md hover:bg-emerald-700">Login</a></li></template>
            </ul>
        </nav>
    </header>

    <!-- PERBAIKAN: Padding-top disesuaikan dengan header h-14 -->
    <main class="flex flex-row h-screen w-screen pt-14" x-cloak>
        <!-- Kolom Gambar -->
        <div class="hidden md:block w-3/5 h-full">
            <div class="bg-amber-600 h-full w-full">
                <img class="w-full h-full object-cover" src="src/main.jpg" alt="Pemandangan Desa" />
            </div>
        </div>

        <!-- Kolom Form Login/Registrasi -->
        <div class="w-full md:w-2/5 h-full flex items-center justify-center p-6 md:px-12 bg-white overflow-auto">
            <div class="w-full max-w-sm">

                <!-- Template Login -->
                <template x-if="mode === 'login'">
                    <div>
                        <h2 class="text-2xl font-bold text-[#139B82] mb-6 text-center">Masuk Akun Warga</h2>
                        
                        <div x-show="message" :class="{ 'bg-green-100 text-green-800': messageType === 'success', 'bg-red-100 text-red-800': messageType === 'error', 'bg-blue-100 text-blue-800': messageType === 'processing' }" class="mb-4 p-3 rounded-lg text-center text-sm" x-text="message"></div>
                        
                        <form @submit.prevent="login" class="space-y-5">
                            <div>
                                <label for="loginNik" class="block text-gray-700 text-sm font-medium mb-2">NIK</label>
                                <input type="text" id="loginNik" x-model="loginNik" required
                                       class="w-full h-[52px] p-3 pl-5 rounded-lg bg-[#F0EDFFCC] font-medium text-sm border border-gray-300 focus:ring-2 focus:ring-[#139B82]"
                                       placeholder="Masukkan NIK Anda" />
                            </div>
                            <div>
                                <label for="loginPassword" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                                <input type="password" id="loginPassword" x-model="loginPassword" required
                                       class="w-full h-[52px] p-3 pl-5 rounded-lg bg-[#F0EDFFCC] font-medium text-sm border border-gray-300 focus:ring-2 focus:ring-[#139B82]"
                                       placeholder="Password" />
                            </div>
                            <button type="submit"
                                    class="w-full h-[50px] bg-[#139B82] text-white p-2 rounded-lg font-bold hover:bg-emerald-700 transition-colors">
                                Login Now
                            </button>
                            <p class="text-sm text-center mt-4 text-gray-600">
                                Belum punya akun?
                                <button type="button" @click="mode = 'register'" class="text-[#139B82] hover:underline font-semibold">Daftar</button>
                            </p>
                        </form>
                    </div>
                </template>

                <!-- Template Registrasi -->
                <template x-if="mode === 'register'">
                     <div>
                        <h2 class="text-2xl font-bold text-[#139B82] mb-6 text-center">Registrasi Akun Warga</h2>
                        
                        <div x-show="message" :class="{ 'bg-green-100 text-green-800': messageType === 'success', 'bg-red-100 text-red-800': messageType === 'error', 'bg-blue-100 text-blue-800': messageType === 'processing' }" class="mb-4 p-3 rounded-lg text-center text-sm" x-text="message"></div>

                        <form @submit.prevent="register" class="space-y-5">
                            <div>
                                <label for="registerNama" class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                                <input type="text" id="registerNama" x-model="registerNama" required
                                       class="w-full h-[52px] p-3 pl-5 rounded-lg bg-[#F0EDFFCC] font-medium text-sm border border-gray-300 focus:ring-2 focus:ring-[#139B82]"
                                       placeholder="Masukkan nama lengkap Anda" />
                            </div>
                             <div>
                                <label for="registerNik" class="block text-gray-700 text-sm font-medium mb-2">NIK</label>
                                <input type="text" id="registerNik" x-model="registerNik" required
                                       class="w-full h-[52px] p-3 pl-5 rounded-lg bg-[#F0EDFFCC] font-medium text-sm border border-gray-300 focus:ring-2 focus:ring-[#139B82]"
                                       placeholder="Masukkan NIK Anda" />
                            </div>
                            <div>
                                <label for="registerPassword" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                                <input type="password" id="registerPassword" x-model="registerPassword" required
                                       class="w-full h-[52px] p-3 pl-5 rounded-lg bg-[#F0EDFFCC] font-medium text-sm border border-gray-300 focus:ring-2 focus:ring-[#139B82]"
                                       placeholder="Buat password" />
                            </div>
                            <button type="submit"
                                    class="w-full h-[50px] bg-[#139B82] text-white p-2 rounded-lg font-bold hover:bg-emerald-700 transition-colors">
                                Daftar Sekarang
                            </button>
                            <p class="text-sm text-center mt-4 text-gray-600">
                                Sudah punya akun?
                                <button type="button" @click="mode = 'login'" class="text-[#139B82] hover:underline font-semibold">Login</button>
                            </p>
                        </form>
                    </div>
                </template>
            </div>
        </div>
    </main>
    
    <!-- PERBAIKAN: Tinggi footer disamakan dengan header -->
    <footer class="flex fixed bottom-0 left-0 w-full h-14 items-center justify-between bg-[#139B82] px-[8vw]">
        <div class="logo">
            <a class="flex items-center gap-1" href="/">
                <img class="h-7 -mt-1" src="https://img.icons8.com/pastel-glyph/64/FFFFFF/marker--v1.png" alt="marker--v1" />
            </a>
        </div>
        <div class="flex gap-4 items-center">
            <a href="#">
                <img src="https://img.icons8.com/?size=25&id=118466&format=png&color=FFFFFF" alt="Facebook">
            </a>
            <a href="#">
                <img src="https://img.icons8.com/?size=25&id=85088&format=png&color=FFFFFF" alt="Instagram">
            </a>
            <a href="#">
                <img src="https://img.icons8.com/?size=25&id=32309&format=png&color=FFFFFF" alt="Twitter">
            </a>
        </div>
    </footer>


    <!-- SCRIPT DENGAN LOGIKA YANG SUDAH BENAR (TIDAK ADA PERUBAHAN) -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('authApp', () => ({
                mode: 'login', 
                message: '',
                messageType: '', 
                loginNik: '',
                loginPassword: '',
                registerNama: '',
                registerNik: '',
                registerPassword: '',

                showMessage(type, text) {
                    this.messageType = type;
                    this.message = text;
                },
                
                async login() {
                    this.showMessage('processing', 'Mencoba masuk...');
                    try {
                        const response = await fetch('http://localhost:5000/api/auth', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nik: this.loginNik, password: this.loginPassword })
                        });
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.errors ? data.errors[0].msg : 'NIK atau Password salah!');
                        }
                        this.showMessage('success', 'Login berhasil! Anda akan dialihkan...');
                        localStorage.setItem('token', data.token);
                        setTimeout(() => { window.location.href = '/admin-dashboard.html'; }, 1500);
                    } catch (error) {
                        console.error('Login Error:', error);
                        this.showMessage('error', error.message);
                    }
                },

                async register() {
                    this.showMessage('processing', 'Mendaftarkan akun...');
                    if (!this.registerNama || !this.registerNik || !this.registerPassword) {
                        this.showMessage('error', 'Semua field wajib diisi.');
                        return;
                    }
                    try {
                        const response = await fetch('http://localhost:5000/api/users', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                nama: this.registerNama, 
                                nik: this.registerNik, 
                                password: this.registerPassword 
                            })
                        });
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.errors ? data.errors[0].msg : 'Registrasi gagal.');
                        }
                        this.showMessage('success', 'Registrasi berhasil! Silakan masuk.');
                        setTimeout(() => {
                            this.mode = 'login';
                            this.message = '';
                            this.registerNama = '';
                            this.registerNik = '';
                            this.registerPassword = '';
                        }, 2000);
                    } catch (error) {
                        console.error('Registration Error:', error);
                        this.showMessage('error', error.message);
                    }
                }
            }));
        });
    </script>
</body>
</html>
